generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "mysql"
  url               = env("DATABASE_URL")
  relationMode      = "prisma"
}

model Branch {
  id   Int    @id @default(autoincrement())
  name String

  userId Int?
  users  User[]

  courses Course[]

  staffAttendances StaffAttendance[]

  createdAt              DateTime                @default(now())
  // lectureSchedules LectureSchedule[]
  historicalFacultyDatas HistoricalFacultyData[]
}

model User {
  id           Int    @id @default(autoincrement())
  name         String
  phoneNumber  String @unique
  password     String
  role         Role
  previousRole Role?

  salary               Int?
  workingMinutesPerDay Int?

  facultyType FACULTY_TYPE?
  lectureRate Int?

  shiftStartTime DateTime?
  shiftEndTime   DateTime?

  branchId Int?
  branch   Branch? @relation(fields: [branchId], references: [id])

  facultySubjects    FacultySubject[]
  lectures           LectureSchedule[]
  staffAttendances   StaffAttendance[]
  facultyAttendances FacultyAttendance[]

  createdAt              DateTime                @default(now())
  historicalFacultyDatas HistoricalFacultyData[]
}

model Subject {
  id      Int    @id @default(autoincrement())
  name    String
  batchId Int
  batch   Batch  @relation(fields: [batchId], references: [id])

  facultySubjects  FacultySubject[]
  lectureSchedules LectureSchedule[]

  @@unique([name, batchId])
}

model FacultySubject {
  id Int @id @default(autoincrement())

  facultyId Int
  subjectId Int

  faculty User    @relation(fields: [facultyId], references: [id])
  subject Subject @relation(fields: [subjectId], references: [id])

  @@unique([facultyId, subjectId])
}

model LectureSchedule {
  id Int @id @default(autoincrement())

  facultyId Int
  subjectId Int
  batchId   Int

  TotalScheduled Int?

  StartDate DateTime
  EndDate   DateTime
  startTime DateTime
  endTime   DateTime

  faculty User    @relation(fields: [facultyId], references: [id])
  subject Subject @relation(fields: [subjectId], references: [id])
  batch   Batch   @relation(fields: [batchId], references: [id])

  attendance LectureAttendance[]

  createdAt DateTime @default(now())
}

model LectureAttendance {
  id Int @id @default(autoincrement())

  lectureId       Int
  date            DateTime    @default(now())
  actualStartTime DateTime?
  actualEndTime   DateTime?
  status          StatusType  @default(CONDUCTED)
  payout          Int         @default(0)
  penalty         PenaltyType @default(NONE)

  lecture LectureSchedule @relation(fields: [lectureId], references: [id])

  createdAt DateTime @default(now())

  @@unique([lectureId, date])
}

model StaffAttendance {
  id Int @id @default(autoincrement())

  staffId Int
  staff   User @relation(fields: [staffId], references: [id])

  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id])

  date           DateTime
  shiftStartTime DateTime
  shiftEndTime   DateTime

  actualInTime  DateTime
  actualOutTime DateTime?

  lateMinutes  Int @default(0)
  extraPenalty Int @default(0)
  totalPenalty Int @default(0)

  isLate Boolean @default(false)

  overtimeMinutes Int @default(0)
  overtimePay     Int @default(0)

  createdAt DateTime @default(now())

  @@unique([staffId, date])
}

model FacultyAttendance {
  id Int @id @default(autoincrement())

  facultyId Int
  faculty   User @relation(fields: [facultyId], references: [id])

  date           DateTime  @default(now())
  inTime         DateTime?
  outTime        DateTime?
  workingMinutes Int       @default(0)
  isLeave        Boolean   @default(false)
  createdAt      DateTime  @default(now())

  @@unique([facultyId, date])
}

model Batch {
  id   Int     @id @default(autoincrement())
  name String
  code String?

  // branchId Int
  // branch   Branch    @relation(fields: [branchId], references: [id])

  courseId Int
  course   Course @relation(fields: [courseId], references: [id])

  subjects         Subject[]
  lectureSchedules LectureSchedule[]
  historicalData   HistoricalFacultyData[]

  createdAt DateTime @default(now())

  @@unique([name, courseId])
}

model Course {
  id   Int     @id @default(autoincrement())
  name String
  code String?

  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id])

  batches Batch[]

  createdAt DateTime @default(now())

  @@unique([name, branchId])
}

model HistoricalFacultyData {
  id           Int       @id @default(autoincrement())
  userId       Int?
  branchId     Int?
  batchId      Int?
  // branchName   String
  facultyName  String?
  date         DateTime?
  Intime       DateTime?
  Outtime      DateTime?
  subject      String?
  totalPenalty Int?
  totalMinutes Int?
  session      String?

  user   User?   @relation(fields: [userId], references: [id])
  branch Branch? @relation(fields: [branchId], references: [id])
  batch  Batch?  @relation(fields: [batchId], references: [id])

  @@unique([userId, batchId, date, session])
}

model HistoricalStaffData {
  id           Int       @id @default(autoincrement())
  staffName    String?
  branchName   String?
  date         DateTime?
  status       String?
  extraHours   Int?
  unpaid       Boolean?
  deficitHours Int?
  shiftStart   String?
  shiftEnd     String?
}

enum PenaltyType {
  NONE
  LATE_START
  EARLY_END
  BOTH
}

enum StatusType {
  CONDUCTED
  CANCELLED
  MISSED
}

enum Role {
  SUPER_ADMIN
  BRANCH_ADMIN
  FACULTY
  STAFF
}

enum FACULTY_TYPE {
  LECTURE_BASED
  SALARY_BASED
}
